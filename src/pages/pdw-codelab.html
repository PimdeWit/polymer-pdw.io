<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../experiments/pointer-follower.html">
<link rel="import" href="../experiments/noise-displacer.html">
<link rel="import" href="../experiments/geo-flower.html">
<link rel="import" href="../experiments/svg-morph.html">
<link rel="import" href="../experiments/steezy-svg.html">
<link rel="import" href="../experiments/rare-numbers.html">
<link rel="import" href="../experiments/the-journey.html">
<link rel="import" href="../experiments/shader-image.html">

<link rel="import" href="../shared-styles.html">

<dom-module id="pdw-codelab">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        position: relative;

        width: 100%;
      }

      .experiment-container {
        position: relative;

        width: 100%;
        height: 90vh;

        contain: strict;

        overflow: hidden;

        will-change: auto;
      }

      .experiment {
        display: flex;

        align-items: center;
        justify-content: center;

        width: 100%;
        height: 100%;

        overflow: hidden;

        background-color: #101111;

        user-select: none;
      }

      .experiment::before,
      .experiment::after {
        pointer-events: none;
      }

      .experiment::before {
        content: '';

        display: block;

        position: absolute;
        z-index: 2;
        top: 0;
        left: 0;

        width: 100%;
        height: 100%;

        transform: translate3d(0, 0, 0);

        box-shadow: inset 0 20vh 0 0 #1a1a1a, inset 0 -20vh 0 0 #1a1a1a;


        transition-property: transform;
        transition-duration: 3s;
        transition-timing-function: cubic-bezier(0.4, 0.0, 0.2, 1);
      }

      .experiment.iron-selected.animate::before {
        transform: scaleY(1.8);
      }

      .experiment::after {
        display: block;
        content: '';

        position: absolute;
        z-index: 1;
        top: 0;
        left: 0;

        width: 100%;
        height: 100%;

        background-color: #000;

        transition-property: opacity;
        transition-duration: 3s;
        transition-timing-function: cubic-bezier(0.4, 0.0, 0.2, 1);

        pointer-events: none;
      }

      .experiment.iron-selected.animate::after {
        opacity: 0;
      }

      .experiment-menu__tabs {
        --paper-tabs-selection-bar-color: #fff;
        --paper-tabs-selection-bar: {
          display: block;
          width: 100%;
          height: 5px;
          background-color: red;
        };

        height: 10vh;
      }

      .experiment-menu__tab {
        padding: 0 16px;
      }

      .experiment-menu__link {
        display: flex;
        align-items: center;
        justify-content: center;

        outline: 0;

        color: white;

        text-decoration: none;
      }

      .experiment-menu__meta {
        opacity: 0.5;
      }

      .experiment__title--mask {
        position: absolute;
        overflow: hidden;
      }

      .experiment__title {

        display: block;

        margin: 0;

        transform: translateY(-100%);

        font-size: 10vw;

        pointer-events: none;
      }

      .experiment.svg-morph {
        background-color: #fad961;
        background-image: linear-gradient(-225deg, #ac32e4 0%, #7918f2 48%, #4801ff 100%);
      }

      .experiment.noise-displacer noise-displacer {
        position: absolute;
        top: 0;
        left: 0;

        width: 100%;
        height: 100%;
      }

      .experiment.noise-displacer #noisedisplacerrange {
        position: absolute;
        bottom: 0;
        left: 0;

        width: 100%;
      }

      .toast {}

      .toast__dismiss {
        position: absolute;
        top: 0;
        left: 0;

        width: 100%;
        height: 100%;

        opacity: 0;
      }
    </style>

    <app-route
        route="[[route]]"
        pattern="/:codelab"
        data="{{routeData}}"></app-route>

    <iron-pages
        id="wrapper"
        class="experiment-container"
        selected="[[route.path]]"
        attr-for-selected="name"
        fallback-selection="404"
        role="main">

      <geo-flower id="geoflower" class="experiment" name="/geoflower"></geo-flower>

      <pointer-follower id="pointerstalker" class="experiment" name="/pointerstalker" rows="160" columns="16" particle-width="2" particle-height="2" distortion="5" threshold="0.99" tag="0.99" clickable></pointer-follower>
      <pointer-follower id="curtains" class="experiment" name="/curtains" rows="8" columns="96" particle-width="48" particle-height="2" distortion="50" clear></pointer-follower>
      <pointer-follower id="nodenetwork" class="experiment" name="/node-network" rows="400" columns="3" particle-width="10" particle-height="1" distortion="100"  tag="0.7" clear></pointer-follower>
      <div id="noisedisplacer" class="experiment noise-displacer" name="/noise-displacer">
        <noise-displacer
            class="noise-displacer"
            text="ðŸ˜ŸðŸ˜¥ðŸ¤¢"
            slice-size="[[_displacementSlice]]"
            noise-x="16"
            noise-y="20"
            noise-width="2"
            noise-height="16"
            density="0.8"
          ></noise-displacer>
        <input id="noisedisplacerrange" type="range" value="8" min="1" max="256" step="1">
      </div>
      <rare-numbers id="rarenumbers" class="experiment" name="/rare-numbers"></rare-numbers>
      <the-journey id="thejourney" class="experiment" name="/the-journey"></the-journey>
      <shader-image id="paradise" texture="images/illustrations/4.jpg" map="images/illustrations/4.jpg" class="experiment" name="/paradise" size-x="400" size-y="600"></shader-image>
      <shader-image id="fire-fractal" texture="images/illustrations/darkness.png" map="images/illustrations/darkness.png" class="experiment" name="/fire-fractal" cover></shader-image>
      <shader-image id="mask-off" texture="images/illustrations/1.jpg" map="images/illustrations/1.jpg" class="experiment" name="/mask-off" size-x="540" size-y="540"></shader-image>
    </iron-pages>

    <!--<h3 class="experiment__title">[[route.path]]</h3>-->
      <template is="dom-repeat" items="[[codelabMenu]]">
          <a class="experiment-menu__link" href="[[item.url]]" name="[[item.name]]">
            <span>[[item.text]]</span>
            <span class="experiment-menu__meta">&nbsp;[[item.year]]</span>
          </a>
      </template>

    <paper-toast id="toast" class="toast" text="The codelab could contain some battery-draining experiments, You may want to check back later when you are charging your device ([[batteryLevel]]%) ðŸ˜³" duration="10000">
      <button class="toast__dismiss" on-tap="_closeToast">DISMISS</button>
    </paper-toast>
  </template>

  <script>
    class PdwCodelab extends Polymer.Element {
      static get is() { return 'pdw-codelab'; }
      static get properties() {
        return {
          assets: Object,

          route: {
            type: Object,
            observer: '_routeObserver',
          },
          routeData: Object,
          batteryCharging: Boolean,
          batteryLevel: String,
          menuItems: Object,
          codelabMenu: {
            type: Array,
            value: [
              {
                name: '/geoflower',
                url: 'codelab/geoflower',
                text: 'Geo Flower',
                year: 2017
              },
              {
                name: '/pointerstalker',
                url: 'codelab/pointerstalker',
                text: 'Pointer Stalker',
                year: 2017
              },
              {
                name: '/curtains',
                url: 'codelab/curtains',
                text: 'Curtains',
                year: 2017
              },
              {
                name: '/node-network',
                url: 'codelab/node-network',
                text: 'Node Network',
                year: 2017
              },
              {
                name: '/noise-displacer',
                url: 'codelab/noise-displacer',
                text: 'Noise Displacer',
                year: 2017
              },
              {
                name: '/rare-numbers',
                url: 'codelab/rare-numbers',
                text: 'Numbers',
                year: 2017,
              },
              {
                name: '/the-journey',
                url: 'codelab/the-journey',
                text: 'The Journey',
                year: 2017,
              },
              {
                name: '/paradise',
                url: 'codelab/paradise',
                text: 'Paradise',
                year: 2017,
              },
              {
                name: '/fire-fractal',
                url: 'codelab/fire-fractal',
                text: 'Fire Fractal',
                year: 2017,
              },
              {
                name: '/mask-off',
                url: 'codelab/mask-off',
                text: 'Mask Off',
                year: 2017,
              }
            ],
          },
          _displacementSlice: {
            type: Number,
            value: 8,
          },
        };
      }

      constructor() {
        super();
      }

      connectedCallback() {
        super.connectedCallback();

        this.battery = new BatteryManager(this.$.toast);

        this._addEventListeners();
      }

      _routeObserver() {
        const activeEl = this.shadowRoot.querySelector('.animate');
        if (activeEl) activeEl.classList.remove('animate');

        Polymer.RenderStatus.afterNextRender(this, () => {
          const path = this.route.path;
          const selector = `a[name="${path}"]`;
          const animateElement = this.shadowRoot.querySelector('.experiment.iron-selected');
          const a = this.shadowRoot.querySelector(selector);

          this.menuItems = this.shadowRoot.querySelectorAll('a[name]');

          for (let i = this.menuItems.length - 1; i >= 0; i--) {
            this.menuItems[i].classList.remove('active');
          }

          if (a) {
            a.classList.add('active');
          }

          if (animateElement) {
            animateElement.classList.add('animate');

            if (animateElement.setToActive) {
              animateElement.setToActive();
            }
          }
        });
      }

      /**
       * Add event listeners
       * @private
       **/
      _addEventListeners() {
        const rangeNoise = this.$.noisedisplacerrange;

        rangeNoise.addEventListener('input', () => {
          this._displacementSlice = rangeNoise.value;
        }, {passive: true});
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._dispose();
      }

      /**
       * Clear up some memory.
       * @private
       */
      _dispose() {
        this.removeEventListeners();
        this.battery = null;
      }

      removeEventListeners() {
        console.warn('removing listeners from codelab');
      }

    }

    /**
     * @type {Object}
     * @param {Number} MAX_POWER_LEVEL The maximum "charging level" a battery can have. (usually 100)
     * @constant
     */
    const BATTERY_CONSTANTS = {
      MAX_POWER_LEVEL: 100
    };

    /**
     * @author Pim de Wit / https://pdw.io/
     * @desc Handles everything battery related.
     * @class
     */
    class BatteryManager {
      /**
       * @param {*} toast
       * @constructor
       */
      constructor(toast) {
        this.toast = toast;

        this._init();
      }

      /**
       * Get the raw battery level and convert it to a human-recognisable number.
       * @static
       */
      static getBatteryLevel(rawLevel) {
        return Math.round(rawLevel * BATTERY_CONSTANTS.MAX_POWER_LEVEL);
      }

      /**
       * Initialise the instance.
       * @async
       * @private
       */
      async _init() {
        this.battery = await navigator.getBattery();

        if (!this.battery) return;

        this._boundChargingChangeHandler = this._onChargingChange.bind(this);

        this._addEventListeners();
        this._onChargingChange();
      }

      /**
       * Add event listeners.
       * @private
       */
      _addEventListeners() {
        this.battery.addEventListener('chargingchange', this._boundChargingChangeHandler);
        this.battery.addEventListener('levelchange', this._boundLevelChangeHandler);
      }

      /**
       * Battery charging handler.
       * @listens BatteryManager.battery.onchargingchange
       */
      _onChargingChange() {
        if (this.battery.charging) {
          this.toast.close();
        } else {
          this.toast.open();
        }
      }

      /**
       * Dispose everything related to this class.
       */
      dispose() {
        this._removeEventListeners();
      }

      /**
       * Remove all event listeners.
       * @private
       */
      _removeEventListeners() {
        this.battery.removeEventListener('chargingchange', this._boundChargingChangeHandler);
      }
    }

    window.customElements.define(PdwCodelab.is, PdwCodelab);
  </script>
</dom-module>
