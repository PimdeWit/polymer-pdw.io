<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">

<link rel="import" href="../experiments/pointer-follower.html">
<link rel="import" href="../experiments/noise-displacer.html">
<link rel="import" href="../experiments/geo-flower.html">
<link rel="import" href="../experiments/svg-morph.html">
<link rel="import" href="../experiments/steezy-svg.html">
<link rel="import" href="../experiments/rare-numbers.html">
<link rel="import" href="../experiments/the-journey.html">

<link rel="import" href="../shared-styles.html">

<dom-module id="pdw-codelab">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        position: relative;

        width: 100%;
      }

      .experiment-container {
        position: relative;

        width: 100%;
        height: 90vh;

        contain: strict;

        overflow: hidden;

        will-change: auto;
      }

      .experiment {
        display: flex;

        align-items: center;
        justify-content: center;

        width: 100%;
        height: 100%;

        overflow: hidden;

        background-color: #101111;

        user-select: none;
      }

      .experiment::before,
      .experiment::after {
        pointer-events: none;
      }

      .experiment::before {
        content: '';

        display: block;

        position: absolute;
        z-index: 2;
        top: 0;
        left: 0;

        width: 100%;
        height: 100%;

        transform: translate3d(0, 0, 0);

        box-shadow: inset 0 20vh 0 0 #1a1a1a, inset 0 -20vh 0 0 #1a1a1a;


        transition-property: transform;
        transition-duration: 3s;
        transition-timing-function: cubic-bezier(0.4, 0.0, 0.2, 1);
      }

      .experiment.iron-selected.animate::before {
        transform: scaleY(1.8);
      }

      .experiment::after {
        display: block;
        content: '';

        position: absolute;
        z-index: 1;
        top: 0;
        left: 0;

        width: 100%;
        height: 100%;

        background-color: #000;

        transition-property: opacity;
        transition-duration: 3s;
        transition-timing-function: cubic-bezier(0.4, 0.0, 0.2, 1);

        pointer-events: none;
      }

      .experiment.iron-selected.animate::after {
        opacity: 0;
      }

      .experiment-menu__tabs {
        --paper-tabs-selection-bar-color: #fff;
        --paper-tabs-selection-bar: {
          display: block;
          width: 100%;
          height: 5px;
          background-color: red;
        };

        height: 10vh;
      }

      .experiment-menu__tab {
        padding: 0 16px;
      }

      .experiment-menu__link {
        display: flex;
        align-items: center;
        justify-content: center;

        outline: 0;

        color: white;

        text-decoration: none;
      }

      .experiment-menu__meta {
        opacity: 0.5;
      }

      .experiment__title--mask {
        position: absolute;
        overflow: hidden;
      }

      .experiment__title {

        display: block;

        margin: 0;

        transform: translateY(-100%);

        font-size: 10vw;

        pointer-events: none;
      }

      .experiment.svg-morph {
        background-color: #fad961;
        background-image: linear-gradient(-225deg, #ac32e4 0%, #7918f2 48%, #4801ff 100%);
      }

      .experiment.noise-displacer noise-displacer {
        position: absolute;
        top: 0;
        left: 0;

        width: 100%;
        height: 100%;
      }

      .experiment.noise-displacer #noisedisplacerrange {
        position: absolute;
        bottom: 0;
        left: 0;

        width: 100%;
      }

      .toast {}

      .toast__dismiss {
        position: absolute;
        top: 0;
        left: 0;

        width: 100%;
        height: 100%;

        opacity: 0;
      }
    </style>

    <app-route
        route="[[route]]"
        pattern="/:codelab"
        data="{{routeData}}"></app-route>

    <iron-pages
        id="wrapper"
        class="experiment-container"
        selected="[[route.path]]"
        attr-for-selected="name"
        fallback-selection="404"
        role="main">

      <geo-flower id="geoflower" class="experiment" name="/geoflower"></geo-flower>

      <pointer-follower id="pointerstalker" class="experiment" name="/pointerstalker" rows="160" columns="16" particle-width="2" particle-height="2" distortion="5" threshold="0.99" tag="0.99" clickable></pointer-follower>
      <pointer-follower id="curtains" class="experiment" name="/curtains" rows="8" columns="96" particle-width="48" particle-height="2" distortion="50" clear></pointer-follower>
      <pointer-follower id="nodenetwork" class="experiment" name="/node-network" rows="400" columns="3" particle-width="10" particle-height="1" distortion="100"  tag="0.7" clear></pointer-follower>
      <div id="noisedisplacer" class="experiment noise-displacer" name="/noise-displacer">
        <noise-displacer
            class="noise-displacer"
            text="ðŸ˜ŸðŸ˜¥ðŸ¤¢"
            slice-size="[[_displacementSlice]]"
            noise-x="16"
            noise-y="20"
            noise-width="2"
            noise-height="16"
            density="0.8"
          ></noise-displacer>
        <input id="noisedisplacerrange" type="range" value="8" min="1" max="256" step="1">
      </div>
      <div id="svgmorph" class="experiment svg-morph" name="/svg-morph">
        <svg-morph stroke-length="900" offset="[[svgOffset]]" style="width: 50vw; height: 50vw;" stroke-length="100">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 320">
            <g fill="none" fill-rule="evenodd" stroke="#fff" stroke-width="4">
              <path d="M160 2.1L62.32 32.27 2 111.23v97.54l60.32 78.95 97.68 30.2 97.68-30.2L318 208.77v-97.54l-60.32-78.95L160 2.08z"/>
              <path d="M160 50.16L82.33 82.33 50.16 160l32.17 77.67L160 269.84l77.67-32.17L269.84 160l-32.17-77.67L160 50.16z"/>
              <path d="M160 2.16L48.4 48.4 2.15 160 48.4 271.6 160 317.85l111.6-46.23L317.85 160 271.6 48.4 160 2.15z"/>
              <path d="M160 2.83L2.83 160 160 317.17 317.17 160 160 2.83z"/>
              <path d="M160 50.83L50.83 160 160 269.17 269.17 160 160 50.83z"/>
              <path d="M160 117.2L142.17 160 160 202.8l17.83-42.8L160 117.2z"/>
            </g>
          </svg>
        <input id="svgrange" type="range" min="1" max="1000" step="1">
      </div>
      <rare-numbers id="rarenumbers" class="experiment" name="/rare-numbers"></rare-numbers>
      <the-journey id="thejourney" class="experiment" name="/the-journey"></the-journey>
    </iron-pages>

    <!--<h3 class="experiment__title">[[route.path]]</h3>-->
    <paper-tabs class="experiment-menu__tabs" selected="[[route.path]]" attr-for-selected="name" role="navigation" scrollable fit-container>
      <template is="dom-repeat" items="[[codelabMenu]]">
        <paper-tab link class="experiment-menu__tab">
          <a class="experiment-menu__link" href="[[item.url]]" name="[[item.name]]" tabindex="-1">
            <span>[[item.text]]</span>
            <span class="experiment-menu__meta">&nbsp;[[item.year]]</span>
          </a>
        </paper-tab>
      </template>
    </paper-tabs>

    <paper-toast id="toast" class="toast" text="The codelab could contain some battery-draining experiments, You may want to check back later when you are charging your device ([[batteryLevel]]%) ðŸ˜³" duration="10000">
      <button class="toast__dismiss" on-tap="_closeToast">DISMISS</button>
    </paper-toast>
  </template>

  <script>
    class PdwCodelab extends Polymer.Element {
      static get is() { return 'pdw-codelab'; }
      static get properties() {
        return {
          assets: Object,

          route: {
            type: Object,
            observer: '_routeObserver',
          },
          routeData: Object,
          batteryCharging: Boolean,
          batteryLevel: String,
          menuItems: Object,
          codelabMenu: {
            type: Array,
            value: [
              {
                name: '/geoflower',
                url: 'codelab/geoflower',
                text: 'Geo Flower',
                year: 2017
              },
              {
                name: '/pointerstalker',
                url: 'codelab/pointerstalker',
                text: 'Pointer Stalker',
                year: 2017
              },
              {
                name: '/curtains',
                url: 'codelab/curtains',
                text: 'Curtains',
                year: 2017
              },
              {
                name: '/node-network',
                url: 'codelab/node-network',
                text: 'Node Network',
                year: 2017
              },
              {
                name: '/noise-displacer',
                url: 'codelab/noise-displacer',
                text: 'Noise Displacer',
                year: 2017
              },
              {
                name: '/svg-morph',
                url: 'codelab/svg-morph',
                text: 'SVG Morph',
                year: 2017
              },
              {
                name: '/sketch-import',
                url: 'codelab/sketch-import',
                text: 'Sketch Import',
                year: 2017,
              },
              {
                name: '/rare-numbers',
                url: 'codelab/rare-numbers',
                text: 'Numbers',
                year: 2017,
              },
              {
                name: '/the-journey',
                url: 'codelab/the-journey',
                text: 'The Journey',
                year: 2017,
              },
            ],
          },
          _displacementSlice: {
            type: Number,
            value: 8,
          },
        };
      }

      constructor() {
        super();
      }

      connectedCallback() {
        super.connectedCallback();

        this._addEventListeners();

        if (navigator.getBattery) {
          navigator.getBattery().then(this._battery.bind(this), () => {
            console.log('There was an error getting the battery');
          });
        } else if (navigator.battery) {
          this._battery(navigator.battery);
        } else {
          console.log('Battery API not supported');
        }
      }

      _routeObserver() {
        const activeEl = this.shadowRoot.querySelector('.animate');
        if (activeEl) activeEl.classList.remove('animate');

        Polymer.RenderStatus.afterNextRender(this, () => {
          const path = this.route.path;
          const selector = `a[name="${path}"]`;
          this.menuItems = this.shadowRoot.querySelectorAll('a[name]');

          for (let i = this.menuItems.length - 1; i >= 0; i--) {
            this.menuItems[i].classList.remove('active');
          }

          const a = this.shadowRoot.querySelector(selector);

          if (a) {
            a.classList.add('active');
          }

          const animateElement = this.shadowRoot.querySelector('.experiment.iron-selected');
          if (animateElement) {
            animateElement.classList.add('animate');

            if (animateElement.setToActive) {
              animateElement.setToActive();
            }
          }
        });
      }

      _battery(battery) {
        window.battery = battery;

        this.batteryCharging = battery.charging;
        this.batteryLevel = this._getBatteryLevel(battery.level);

        if (!battery.charging) this._openToast();

        battery.addEventListener('chargingchange', () => {
          this.batteryCharging = battery.charging;

          battery.charging ? this._closeToast() : this._openToast();
        }, false);

        battery.addEventListener('levelchange', () => {
          this.batteryLevel = this._getBatteryLevel(battery.level);
        });
      }

      /**
       * @param {Number} value
       * @private
       * @return {Number}
       **/
      _getBatteryLevel(value) {
        return Math.round(value * 100);
      }

      /**
       * Add event listeners
       * @private
       **/
      _addEventListeners() {
        const svgRange = this.$.svgrange;

        svgRange.addEventListener('input', () => {
          this.svgOffset = svgRange.value;
        }, {passive: true});

        const rangeNoise = this.$.noisedisplacerrange;

        rangeNoise.addEventListener('input', () => {
          this._displacementSlice = rangeNoise.value;
        }, {passive: true});
      }

      /**
       * Open a small dismissible message for the user.
       * @private
       */
      _openToast() {
        this.$.toast.show();
      }

      /**
       * Close the toast!
       * @private
       */
      _closeToast() {
        this.$.toast.hide();
      }
    }

    window.customElements.define(PdwCodelab.is, PdwCodelab);
  </script>
</dom-module>
